<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Chat Pro</title>
  
  <style>
  :root {
    --bg-color: #0b141a;
    --header-bg: #202c33;
    --incoming-bg: #202c33;
    --outgoing-bg: #005c4b;
    --accent: #00a884;
    --text-primary: #e9edef;
    --text-secondary: #8696a0;
    --system-msg-bg: #182229;
  }

  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  /* --- HEADER --- */
  header { background: var(--header-bg); padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.3); z-index: 20; height: 60px; box-sizing: border-box; }
  .user-info { display: flex; align-items: center; gap: 12px; }
  .avatar { width: 40px; height: 40px; background: #6b7280; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: white; }
  
  .header-text { display: flex; flex-direction: column; justify-content: center; }
  
  /* NEW: Connection Indicator */
  .header-title-row { display: flex; align-items: center; gap: 8px; }
  .header-title { font-weight: bold; font-size: 16px; }
  .conn-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; transition: background 0.3s ease; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
  .conn-dot.online { background: #22c55e; box-shadow: 0 0 8px #22c55e; } /* Green */
  .conn-dot.offline { background: #ef4444; box-shadow: 0 0 8px #ef4444; } /* Red */

  .header-subtitle { font-size: 13px; color: var(--text-secondary); transition: color 0.3s; height: 16px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
  .typing-anim { color: var(--accent); font-weight: bold; }

  /* --- MESSAGES AREA --- */
  main { flex: 1; overflow-y: auto; padding: 20px 5%; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: var(--bg-color); display: flex; flex-direction: column; gap: 6px; }
  
  .system-msg { align-self: center; background: var(--system-msg-bg); color: #8696a0; padding: 5px 12px; border-radius: 8px; font-size: 12.5px; margin: 8px 0; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.2); border: 1px solid #2a3942; }

  /* Chat Bubbles */
  .msg-row { display: flex; margin-bottom: 2px; position: relative; width: 100%; }
  .msg-row.own { justify-content: flex-end; }
  
  .msg { 
    background: var(--incoming-bg); 
    padding: 6px 9px 8px 9px; 
    border-radius: 8px; 
    max-width: 75%; 
    min-width: 80px;
    position: relative; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.2); 
    font-size: 14.2px;
    line-height: 19px;
  }
  .msg.own { background: var(--outgoing-bg); border-top-right-radius: 0; }
  .msg:not(.own) { border-top-left-radius: 0; }

  .msg-name { font-size: 12.5px; font-weight: bold; color: #fab005; margin-bottom: 2px; display: block; cursor: pointer;}
  .msg.own .msg-name { display: none; }

  .msg img { max-width: 100%; border-radius: 6px; margin-top: 4px; display: block; cursor: pointer; }
  .msg audio { width: 220px; margin-top: 5px; }

  .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 3px; font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 2px; float: right; margin-left: 8px; position: relative; top: 3px;}
  
  .reply-preview { border-left: 4px solid var(--accent); background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; font-size: 12px; margin-bottom: 5px; color: rgba(255,255,255,0.8); cursor: pointer; display: flex; flex-direction: column; }

  .msg-menu-btn { position: absolute; top: 0; right: 0; width: 25px; height: 25px; background: linear-gradient(90deg, transparent, var(--incoming-bg) 40%); border: none; cursor: pointer; display: none; color: #8696a0; border-top-right-radius: 8px; text-align: right; padding-right: 5px;}
  .msg.own .msg-menu-btn { background: linear-gradient(90deg, transparent, var(--outgoing-bg) 40%); }
  .msg:hover .msg-menu-btn { display: block; }

  .context-menu { position: absolute; background: #233138; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 100; overflow: hidden; min-width: 150px; display: none; padding: 5px 0;}
  .context-menu button { width: 100%; text-align: left; background: none; border: none; color: white; padding: 10px 15px; cursor: pointer; font-size: 14px; }
  .context-menu button:hover { background: #111b21; }

  /* Footer */
  #inputArea { background: var(--header-bg); padding: 8px 10px; display: flex; align-items: flex-end; gap: 8px; min-height: 50px; box-sizing: border-box;}
  
  .icon-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 5px; transition: 0.2s; height: 40px; display: flex; align-items: center;}
  .icon-btn:hover { color: var(--text-primary); }
  
  #textInput { flex: 1; background: #2a3942; border: none; border-radius: 8px; padding: 10px 12px; color: white; outline: none; font-size: 15px; max-height: 100px; overflow-y: auto; height: 20px; margin-bottom: 5px;}
  /* Disabled state for offline */
  #textInput:disabled { opacity: 0.6; cursor: not-allowed; }
  
  /* Emoji Picker */
  #emojiPicker { position: absolute; bottom: 70px; left: 10px; background: #233138; border-radius: 8px; padding: 10px; display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; height: 200px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 50; }
  .emoji-item { cursor: pointer; font-size: 24px; padding: 5px; text-align: center; }
  .emoji-item:hover { background: rgba(255,255,255,0.1); border-radius: 4px; }

  /* Reply UI */
  #replyContainer { background: #1f2c34; padding: 8px 15px; border-left: 5px solid var(--accent); display: none; animation: slideUp 0.2s; position: absolute; bottom: 60px; width: 90%; left: 5%; border-radius: 8px; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); z-index: 10; box-sizing: border-box;}
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
  </style>
</head>

<body>

<header>
  <div class="user-info">
    <div class="avatar">üë•</div>
    <div class="header-text">
      <div class="header-title-row">
        <div class="header-title">Chat Group</div>
        <span id="connDot" class="conn-dot offline"></span>
      </div>
      <div id="statusText" class="header-subtitle">Connecting...</div>
    </div>
  </div>
  <div style="display: flex; gap:10px;">
    <input id="nameInput" type="text" placeholder="Your Name" value="Guest" 
           style="background:#2a3942; border:none; color:white; padding:5px; border-radius:4px; width:80px; text-align:center;">
  </div>
</header>

<main id="messages"></main>

<div id="ctxMenu" class="context-menu">
  <button onclick="triggerReply()">‚Ü©Ô∏è Reply</button>
  <button id="ctxEditBtn" onclick="triggerEdit()">‚úèÔ∏è Edit</button>
  <button id="ctxDeleteBtn" style="color:#ef4444" onclick="triggerDelete()">üóëÔ∏è Delete For Everyone</button>
</div>

<div id="replyContainer">
  <div style="display:flex; justify-content:space-between; margin-bottom: 2px;">
    <span style="color:var(--accent); font-size:12px; font-weight:bold;">Replying...</span>
    <button onclick="cancelReply()" style="background:none;border:none;color:#8696a0;cursor:pointer;">‚úñ</button>
  </div>
  <div id="replyTextDisplay" style="color:rgba(255,255,255,0.7); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
</div>

<div id="emojiPicker"></div>

<div id="inputArea">
  <button class="icon-btn" onclick="toggleEmoji()">üòä</button>
  <button class="icon-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
  <input type="file" id="fileInput" hidden accept="image/*,audio/*">
  
  <input id="textInput" type="text" placeholder="Type a message" autocomplete="off" disabled>
  
  <button id="sendBtn" class="icon-btn" style="color: var(--accent); display:none;">‚û§</button>
</div>

<script>
const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`);
const messagesEl = document.getElementById('messages');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');
const nameInput = document.getElementById('nameInput');
const statusText = document.getElementById('statusText');
const connDot = document.getElementById('connDot'); // Status Dot
const replyContainer = document.getElementById('replyContainer');
const ctxMenu = document.getElementById('ctxMenu');

let currentReplyId = null;
let selectedMsgId = null;
let messagesMap = {};
let typingUsers = new Set();
let onlineCount = 0;

// --- WEBSOCKET EVENTS ---
ws.onopen = () => {
  // SET ONLINE STATUS
  connDot.className = "conn-dot online";
  textInput.disabled = false;
  textInput.placeholder = "Type a message";
  ws.send(JSON.stringify({ type: 'join', name: nameInput.value }));
};

ws.onclose = () => {
  // SET OFFLINE STATUS
  connDot.className = "conn-dot offline";
  statusText.innerText = "Offline (Connection Lost) üî¥";
  statusText.style.color = "#ef4444";
  textInput.disabled = true;
  textInput.placeholder = "Connecting...";
};

ws.onmessage = (ev) => {
  const data = JSON.parse(ev.data);

  if (data.type === 'message') appendMessage(data);
  else if (data.type === 'system') appendSystemMessage(data.text);
  else if (data.type === 'delete') removeMessageUI(data.id);
  else if (data.type === 'edit') updateMessageUI(data.id, data.newText);
  else if (data.type === 'count') updateStatus(data.count);
  else if (data.type === 'typing') handleTyping(data.name, true);
  else if (data.type === 'stopTyping') handleTyping(data.name, false);
};

// --- LOGIC: STATUS & TYPING ---
function updateStatus(count) {
  if (count !== undefined) onlineCount = count;
  
  if (typingUsers.size > 0) {
    const names = Array.from(typingUsers).join(', ');
    statusText.innerHTML = `<span class="typing-anim">${names} is typing...</span>`;
  } else {
    statusText.innerText = `${onlineCount} participants online`;
    statusText.style.color = 'var(--text-secondary)';
  }
}

function handleTyping(name, isTyping) {
  if (isTyping) typingUsers.add(name);
  else typingUsers.delete(name);
  updateStatus();
}

// --- LOGIC: SENDING ---
function sendMessage(mediaUrl = null, mediaType = null) {
  const text = textInput.value.trim();
  if (!text && !mediaUrl) return;

  const msg = {
    type: 'message',
    id: Date.now(),
    name: nameInput.value,
    text: text,
    mediaUrl, 
    mediaType,
    replyTo: currentReplyId
  };

  ws.send(JSON.stringify(msg));
  textInput.value = '';
  cancelReply();
  toggleSendButton();
}

// --- LOGIC: RENDERING ---
function appendMessage(data) {
  const isOwn = data.name === nameInput.value;
  const row = document.createElement('div');
  row.className = `msg-row ${isOwn ? 'own' : ''}`;
  row.dataset.id = data.id;

  let replyHTML = '';
  if (data.replyTo && messagesMap[data.replyTo]) {
    const original = messagesMap[data.replyTo];
    const previewTxt = original.mediaType ? `üì∑ ${original.mediaType}` : original.text;
    replyHTML = `<div class="reply-preview"><strong>${original.name}</strong><span>${previewTxt}</span></div>`;
  }

  let contentHTML = data.text ? `<span>${data.text}</span>` : '';
  if (data.mediaType === 'image') contentHTML += `<img src="${data.mediaUrl}">`;
  if (data.mediaType === 'audio') contentHTML += `<br><audio controls src="${data.mediaUrl}"></audio>`;

  const time = new Date(data.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  row.innerHTML = `
    <div class="msg ${isOwn ? 'own' : ''}">
      <button class="msg-menu-btn" onclick="openCtxMenu(event, ${data.id}, ${isOwn})">‚åµ</button>
      ${!isOwn ? `<span class="msg-name">${data.name}</span>` : ''}
      ${replyHTML}
      <div class="msg-content">${contentHTML}</div>
      <div class="msg-meta">
        <span>${time}</span>
        ${isOwn ? '<span style="color:#53bdeb">‚úì‚úì</span>' : ''}
      </div>
    </div>
  `;

  messagesEl.appendChild(row);
  scrollToBottom();
  messagesMap[data.id] = data;
}

function appendSystemMessage(text) {
  const el = document.createElement('div');
  el.className = 'system-msg';
  el.innerText = text;
  messagesEl.appendChild(el);
  scrollToBottom();
}

function removeMessageUI(id) {
  const el = document.querySelector(`.msg-row[data-id="${id}"] .msg-content`);
  if (el) {
    el.innerHTML = `<i style="color: #8696a0; font-size:13px;">üö´ This message was deleted</i>`;
    const img = el.parentNode.querySelector('img');
    if(img) img.remove();
  }
}

function updateMessageUI(id, newText) {
    const el = document.querySelector(`.msg-row[data-id="${id}"] .msg-content`);
    if(el) el.innerText = newText;
}

// --- UTILS & HANDLERS ---
function scrollToBottom() { messagesEl.scrollTop = messagesEl.scrollHeight; }

let typingTimeout;
textInput.addEventListener('input', () => {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'typing', name: nameInput.value }));
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => ws.send(JSON.stringify({ type: 'stopTyping', name: nameInput.value })), 1000);
  }
  toggleSendButton();
});

textInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });
sendBtn.onclick = () => sendMessage();

function toggleSendButton() {
  sendBtn.style.display = textInput.value.trim() ? 'block' : 'none';
}

// --- CONTEXT MENU ---
function openCtxMenu(e, id, isOwn) {
  e.stopPropagation();
  selectedMsgId = id;
  const menu = document.getElementById('ctxMenu');
  
  document.getElementById('ctxEditBtn').style.display = isOwn ? 'block' : 'none';
  document.getElementById('ctxDeleteBtn').style.display = isOwn ? 'block' : 'none';

  const rect = e.target.getBoundingClientRect();
  menu.style.top = `${rect.bottom}px`;
  menu.style.left = isOwn ? 'auto' : `${rect.left}px`;
  menu.style.right = isOwn ? '20px' : 'auto';
  menu.style.display = 'block';
}

window.onclick = () => ctxMenu.style.display = 'none';

function triggerDelete() { 
  ws.send(JSON.stringify({ type: 'delete', id: selectedMsgId })); 
}

function triggerEdit() {
    const msg = messagesMap[selectedMsgId];
    if(msg) {
        const newText = prompt("Edit message:", msg.text);
        if(newText && newText !== msg.text) {
             ws.send(JSON.stringify({ type: 'edit', id: selectedMsgId, text: newText }));
        }
    }
}

function triggerReply() {
  currentReplyId = selectedMsgId;
  const msg = messagesMap[selectedMsgId];
  document.getElementById('replyTextDisplay').innerText = msg.text || (msg.mediaType ? 'üì∑ Media' : '...');
  replyContainer.style.display = 'block';
  textInput.focus();
}

function cancelReply() {
  currentReplyId = null;
  replyContainer.style.display = 'none';
}

// --- FILE UPLOAD ---
document.getElementById('fileInput').addEventListener('change', async function() {
  const file = this.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append('file', file);
  
  const res = await fetch('/upload', { method: 'POST', body: formData });
  const data = await res.json();
  if (data.url) sendMessage(data.url, file.type.startsWith('image') ? 'image' : 'file');
});

// --- EMOJIS ---
const emojis = ["üòÄ","üòÇ","üòç","ü•∫","üòé","üò≠","üò°","üëç","üëé","üéâ","üî•","‚ù§Ô∏è","üíî","üëÄ"];
const picker = document.getElementById('emojiPicker');
emojis.forEach(e => {
  const s = document.createElement('span');
  s.className = 'emoji-item';
  s.innerText = e;
  s.onclick = () => { textInput.value += e; toggleSendButton(); };
  picker.appendChild(s);
});
function toggleEmoji() { picker.style.display = picker.style.display === 'grid' ? 'none' : 'grid'; }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Chat Pro Ultra üíé</title>
  
  <style>
  :root {
    --bg-color: #0b141a;
    --header-bg: #202c33;
    --incoming-bg: #202c33;
    --outgoing-bg: #005c4b;
    --accent: #00a884;
    --text-primary: #e9edef;
    --text-secondary: #8696a0;
    --system-msg-bg: #182229;
  }

  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  /* --- HEADER --- */
  header { background: var(--header-bg); padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.3); z-index: 20; height: 60px; box-sizing: border-box; }
  
  .user-info { display: flex; align-items: center; gap: 12px; flex: 1; }
  .avatar { width: 40px; height: 40px; background: #6b7280; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: white; cursor: default; }
  
  .header-text { display: flex; flex-direction: column; justify-content: center; }
  .header-title-row { display: flex; align-items: center; gap: 8px; }
  .header-title { font-weight: bold; font-size: 16px; white-space: nowrap;}
  
  .room-badge { font-size: 10px; background: #374151; padding: 2px 6px; border-radius: 4px; color: #aebac1; border: 1px solid #4b5563; white-space: nowrap; }
  
  .conn-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; transition: background 0.3s ease; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
  .conn-dot.online { background: #22c55e; box-shadow: 0 0 8px #22c55e; } 
  .conn-dot.offline { background: #ef4444; box-shadow: 0 0 8px #ef4444; } 

  .header-subtitle { font-size: 13px; color: var(--text-secondary); height: 16px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px; }
  .typing-anim { color: var(--accent); font-weight: bold; }

  /* Controls Area */
  .controls-area { display: flex; align-items: center; gap: 8px; }

  #nameInput { background: #2a3942; border: 1px solid #374151; color: white; padding: 6px 10px; border-radius: 6px; width: 80px; text-align: center; outline: none; font-weight: bold; font-size: 13px; transition: 0.2s; }
  #nameInput:focus { border-color: var(--accent); }

  /* Buttons */
  .private-btn { background: #1f2c34; border: 1px solid var(--accent); color: var(--accent); padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: 0.2s; white-space: nowrap; font-weight: bold; }
  .private-btn:hover { background: var(--accent); color: white; }

  .leave-btn { background: #3f1818; border: 1px solid #ef4444; color: #ef4444; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: 0.2s; white-space: nowrap; font-weight: bold; display: none; }
  .leave-btn:hover { background: #ef4444; color: white; }

  /* --- MESSAGES AREA --- */
  main { flex: 1; overflow-y: auto; padding: 20px 5%; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: var(--bg-color); display: flex; flex-direction: column; gap: 6px; }
  
  .system-msg { align-self: center; background: var(--system-msg-bg); color: #8696a0; padding: 5px 12px; border-radius: 8px; font-size: 12.5px; margin: 8px 0; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.2); border: 1px solid #2a3942; }

  .msg-row { display: flex; margin-bottom: 2px; position: relative; width: 100%; }
  .msg-row.own { justify-content: flex-end; }
  
  .msg { background: var(--incoming-bg); padding: 6px 9px 8px 9px; border-radius: 8px; max-width: 75%; min-width: 80px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.2); font-size: 14.2px; line-height: 19px; }
  .msg.own { background: var(--outgoing-bg); border-top-right-radius: 0; }
  .msg:not(.own) { border-top-left-radius: 0; }

  .msg-name { font-size: 12.5px; font-weight: bold; color: #fab005; margin-bottom: 2px; display: block; cursor: pointer;}
  .msg.own .msg-name { display: none; }

  .msg img { max-width: 100%; border-radius: 6px; margin-top: 4px; display: block; cursor: pointer; }
  .msg audio { width: 200px; margin-top: 5px; height: 40px; }

  .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 3px; font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 2px; float: right; margin-left: 8px; position: relative; top: 3px;}
  
  .reply-preview { border-left: 4px solid var(--accent); background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; font-size: 12px; margin-bottom: 5px; color: rgba(255,255,255,0.8); cursor: pointer; display: flex; flex-direction: column; }

  .msg-menu-btn { position: absolute; top: 0; right: 0; width: 25px; height: 25px; background: linear-gradient(90deg, transparent, var(--incoming-bg) 40%); border: none; cursor: pointer; display: none; color: #8696a0; border-top-right-radius: 8px; text-align: right; padding-right: 5px;}
  .msg.own .msg-menu-btn { background: linear-gradient(90deg, transparent, var(--outgoing-bg) 40%); }
  .msg:hover .msg-menu-btn { display: block; }

  .context-menu { position: absolute; background: #233138; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 100; overflow: hidden; min-width: 150px; display: none; padding: 5px 0;}
  .context-menu button { width: 100%; text-align: left; background: none; border: none; color: white; padding: 10px 15px; cursor: pointer; font-size: 14px; }
  .context-menu button:hover { background: #111b21; }

  /* Footer & Inputs */
  #inputArea { background: var(--header-bg); padding: 8px 10px; display: flex; align-items: flex-end; gap: 8px; min-height: 50px; box-sizing: border-box;}
  
  .icon-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 5px; transition: 0.2s; height: 40px; display: flex; align-items: center;}
  .icon-btn:hover { color: var(--text-primary); }
  
  #textInput { flex: 1; background: #2a3942; border: none; border-radius: 8px; padding: 10px 12px; color: white; outline: none; font-size: 15px; max-height: 100px; overflow-y: auto; height: 20px; margin-bottom: 5px;}
  #textInput:disabled { opacity: 0.6; cursor: not-allowed; }

  /* Voice Recorder UI */
  #recordingUI { display: none; flex: 1; align-items: center; justify-content: space-between; background: #2a3942; padding: 0 15px; border-radius: 8px; height: 40px; margin-bottom: 5px; color: #ef4444; font-weight: bold; }
  .pulse { animation: pulse 1s infinite; }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  
  #emojiPicker { position: absolute; bottom: 70px; left: 10px; background: #233138; border-radius: 8px; padding: 10px; display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; height: 200px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 50; }
  .emoji-item { cursor: pointer; font-size: 24px; padding: 5px; text-align: center; }
  
  #replyContainer { background: #1f2c34; padding: 8px 15px; border-left: 5px solid var(--accent); display: none; position: absolute; bottom: 60px; width: 90%; left: 5%; border-radius: 8px; z-index: 10; box-sizing: border-box;}

  /* --- MODAL (Room Selection) --- */
  #roomModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
  .modal-content { background: #202c33; padding: 25px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #374151; }
  .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: var(--text-primary); }
  .modal-btn { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
  
  .btn-enter { background: var(--accent); color: white; }
  .btn-cancel { background: transparent; color: #ef4444; margin-top: 10px; }
  
  .room-input { width: 90%; padding: 10px; background: #0b141a; border: 1px solid #374151; border-radius: 8px; color: white; margin-bottom: 15px; outline: none; text-align: center; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
  .room-input:focus { border-color: var(--accent); }

  /* Mobile Tweaks */
  @media (max-width: 400px) {
    .header-title { display: none; } 
    #nameInput { width: 60px; }
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
  </style>
</head>

<body>

<div id="roomModal">
  <div class="modal-content">
    <div class="modal-title">üîí Private Chat</div>
    <p style="color:#8696a0; font-size:13px; margin-bottom:15px;">Enter a Room Code to Create or Join a room.</p>
    
    <input id="roomInput" type="text" class="room-input" placeholder="e.g. MYROOM123">
    
    <button class="modal-btn btn-enter" onclick="submitRoom()">üöÄ Create / Join Room</button>
    <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
  </div>
</div>

<header>
  <div class="user-info">
    <div class="avatar">üë•</div>
    <div class="header-text">
      <div class="header-title-row">
        <div class="header-title">Chat Group</div>
        <span id="roomBadge" class="room-badge">Global</span>
        <span id="connDot" class="conn-dot offline"></span>
      </div>
      <div id="statusText" class="header-subtitle">Connecting...</div>
    </div>
  </div>

  <div class="controls-area">
    <input id="nameInput" type="text" placeholder="Name" value="Guest">
    
    <button id="privateBtn" class="private-btn" onclick="openModal()">üîí Private</button>
    
    <button id="leaveBtn" class="leave-btn" onclick="leaveRoom()">üö™ Exit</button>
  </div>
</header>

<main id="messages"></main>

<div id="ctxMenu" class="context-menu">
  <button onclick="triggerReply()">‚Ü©Ô∏è Reply</button>
  <button id="ctxEditBtn" onclick="triggerEdit()">‚úèÔ∏è Edit</button>
  <button id="ctxDeleteBtn" style="color:#ef4444" onclick="triggerDelete()">üóëÔ∏è Delete For Everyone</button>
</div>

<div id="replyContainer">
  <div style="display:flex; justify-content:space-between; margin-bottom: 2px;">
    <span style="color:var(--accent); font-size:12px; font-weight:bold;">Replying...</span>
    <button onclick="cancelReply()" style="background:none;border:none;color:#8696a0;cursor:pointer;">‚úñ</button>
  </div>
  <div id="replyTextDisplay" style="color:rgba(255,255,255,0.7); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
</div>

<div id="emojiPicker"></div>

<div id="inputArea">
  <button class="icon-btn" onclick="toggleEmoji()">üòä</button>
  <button class="icon-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
  <input type="file" id="fileInput" hidden accept="image/*,audio/*">
  
  <input id="textInput" type="text" placeholder="Type a message" autocomplete="off" disabled>
  
  <div id="recordingUI">
    <span class="pulse">üî¥ Recording...</span>
    <div>
      <button class="icon-btn" onclick="cancelRecording()" style="color:#ef4444; font-size: 20px;">‚úñ</button>
      <button class="icon-btn" onclick="finishRecording()" style="color:#22c55e; font-size: 20px;">‚úî</button>
    </div>
  </div>

  <button id="micBtn" class="icon-btn" onclick="startRecording()">üé§</button>
  <button id="sendBtn" class="icon-btn" style="color: var(--accent); display:none;">‚û§</button>
</div>

<script>
const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`);
const messagesEl = document.getElementById('messages');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const statusText = document.getElementById('statusText');
const connDot = document.getElementById('connDot');
const replyContainer = document.getElementById('replyContainer');
const roomModal = document.getElementById('roomModal');
const roomBadge = document.getElementById('roomBadge');
const recordingUI = document.getElementById('recordingUI');
const nameInput = document.getElementById('nameInput');

const privateBtn = document.getElementById('privateBtn');
const leaveBtn = document.getElementById('leaveBtn');

let currentReplyId = null;
let selectedMsgId = null;
let messagesMap = {};
let typingUsers = new Set();
let currentRoom = "global";

// Voice Vars
let mediaRecorder;
let audioChunks = [];

// --- WEBSOCKET EVENTS ---
ws.onopen = () => {
  connDot.className = "conn-dot online";
  textInput.disabled = false;
  textInput.placeholder = "Type a message";
  ws.send(JSON.stringify({ type: 'join', name: nameInput.value }));
};

ws.onclose = () => {
  connDot.className = "conn-dot offline";
  statusText.innerText = "Offline (Connection Lost) üî¥";
  statusText.style.color = "#ef4444";
  textInput.disabled = true;
};

ws.onmessage = (ev) => {
  const data = JSON.parse(ev.data);
  if (data.type === 'message') appendMessage(data);
  else if (data.type === 'system') appendSystemMessage(data.text);
  else if (data.type === 'delete') removeMessageUI(data.id);
  else if (data.type === 'edit') updateMessageUI(data.id, data.newText);
  else if (data.type === 'count') updateStatus(data.count);
  else if (data.type === 'typing') handleTyping(data.name, true);
  else if (data.type === 'stopTyping') handleTyping(data.name, false);
};

// --- ROOM LOGIC ---
function openModal() { roomModal.style.display = "flex"; document.getElementById('roomInput').focus(); }
function closeModal() { roomModal.style.display = "none"; }

function submitRoom() {
  const id = document.getElementById('roomInput').value.trim().toUpperCase();
  if(!id) return alert("Please enter a room code!");
  joinRoom(id);
}

function leaveRoom() {
  if(confirm("Are you sure you want to leave this room?")) {
    joinRoom('global');
  }
}

function joinRoom(roomId) {
  currentRoom = roomId;
  messagesEl.innerHTML = ''; 
  messagesMap = {}; 
  
  // UI Updates based on Room
  if (roomId === 'global') {
    roomBadge.innerText = 'Global';
    document.querySelector('.header-title').innerText = 'Chat Group';
    leaveBtn.style.display = 'none';
    privateBtn.style.display = 'block';
  } else {
    roomBadge.innerText = `ID: ${roomId}`;
    document.querySelector('.header-title').innerText = 'Private Chat';
    leaveBtn.style.display = 'block';
    privateBtn.style.display = 'none';
  }
  
  ws.send(JSON.stringify({ type: 'joinRoom', roomId: roomId }));
  
  if (roomId !== 'global') {
    appendSystemMessage(`You joined room: ${roomId}`);
    appendSystemMessage(`Share code "${roomId}" with friends to chat!`);
  } else {
    appendSystemMessage(`You joined Global Chat`);
  }
  
  closeModal();
}

// --- VOICE RECORDING LOGIC ---
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.start();

    textInput.style.display = 'none';
    recordingUI.style.display = 'flex';
    micBtn.style.display = 'none';
  } catch (err) {
    alert("Microphone access needed!");
    console.error(err);
  }
}

function cancelRecording() {
  if(mediaRecorder) {
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(track => track.stop());
  }
  resetInputUI();
}

function finishRecording() {
  if (!mediaRecorder) return;
  mediaRecorder.stop();
  mediaRecorder.stream.getTracks().forEach(track => track.stop());
  
  mediaRecorder.onstop = async () => {
    const blob = new Blob(audioChunks, { type: 'audio/webm' });
    resetInputUI();
    
    const formData = new FormData();
    formData.append('file', blob, 'voice-note.webm');
    
    appendSystemMessage("Sending audio...");
    try {
      const res = await fetch('/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if(data.url) sendMessage(data.url, 'audio');
    } catch(e) { console.error(e); }
  };
}

function resetInputUI() {
  textInput.style.display = 'block';
  recordingUI.style.display = 'none';
  micBtn.style.display = 'block';
  sendBtn.style.display = 'none';
}

// --- STANDARD CHAT LOGIC ---
function updateStatus(count) {
  if (typingUsers.size > 0) {
    statusText.innerHTML = `<span class="typing-anim">${Array.from(typingUsers).join(', ')} typing...</span>`;
  } else {
    statusText.innerText = `${count} participants`;
    statusText.style.color = 'var(--text-secondary)';
  }
}

function handleTyping(name, isTyping) {
  if (isTyping) typingUsers.add(name); else typingUsers.delete(name);
  updateStatus();
}

function sendMessage(mediaUrl = null, mediaType = null) {
  const text = textInput.value.trim();
  if (!text && !mediaUrl) return;

  const msg = {
    type: 'message',
    id: Date.now(),
    name: nameInput.value,
    text: text,
    mediaUrl, 
    mediaType,
    replyTo: currentReplyId
  };

  ws.send(JSON.stringify(msg));
  textInput.value = '';
  cancelReply();
  toggleSendButton();
}

function appendMessage(data) {
  const isOwn = data.name === nameInput.value;
  const row = document.createElement('div');
  row.className = `msg-row ${isOwn ? 'own' : ''}`;
  row.dataset.id = data.id;

  let replyHTML = '';
  if (data.replyTo && messagesMap[data.replyTo]) {
    const original = messagesMap[data.replyTo];
    const previewTxt = original.mediaType ? `üì∑ ${original.mediaType}` : original.text;
    replyHTML = `<div class="reply-preview"><strong>${original.name}</strong><span>${previewTxt}</span></div>`;
  }

  let contentHTML = data.text ? `<span>${data.text}</span>` : '';
  if (data.mediaType === 'image') contentHTML += `<img src="${data.mediaUrl}">`;
  if (data.mediaType === 'audio') contentHTML += `<br><audio controls src="${data.mediaUrl}"></audio>`;

  row.innerHTML = `
    <div class="msg ${isOwn ? 'own' : ''}">
      <button class="msg-menu-btn" onclick="openCtxMenu(event, ${data.id}, ${isOwn})">‚åµ</button>
      ${!isOwn ? `<span class="msg-name">${data.name}</span>` : ''}
      ${replyHTML}
      <div class="msg-content">${contentHTML}</div>
      <div class="msg-meta">
        <span>${new Date(data.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        ${isOwn ? '<span style="color:#53bdeb">‚úì‚úì</span>' : ''}
      </div>
    </div>
  `;
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  messagesMap[data.id] = data;
}

function appendSystemMessage(text) {
  const el = document.createElement('div');
  el.className = 'system-msg';
  el.innerText = text;
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// --- UTILS ---
let typingTimeout;
textInput.addEventListener('input', () => {
  ws.send(JSON.stringify({ type: 'typing', name: nameInput.value }));
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => ws.send(JSON.stringify({ type: 'stopTyping', name: nameInput.value })), 1000);
  toggleSendButton();
});

textInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });
sendBtn.onclick = () => sendMessage();

function toggleSendButton() {
  const hasText = textInput.value.trim().length > 0;
  sendBtn.style.display = hasText ? 'block' : 'none';
  micBtn.style.display = hasText ? 'none' : 'block';
}

// --- CONTEXT MENU & EXTRAS ---
const ctxMenu = document.getElementById('ctxMenu');
function openCtxMenu(e, id, isOwn) {
  e.stopPropagation();
  selectedMsgId = id;
  const menu = ctxMenu;
  document.getElementById('ctxEditBtn').style.display = isOwn ? 'block' : 'none';
  document.getElementById('ctxDeleteBtn').style.display = isOwn ? 'block' : 'none';
  const rect = e.target.getBoundingClientRect();
  menu.style.top = `${rect.bottom}px`;
  menu.style.left = isOwn ? 'auto' : `${rect.left}px`;
  menu.style.right = isOwn ? '20px' : 'auto';
  menu.style.display = 'block';
}
window.onclick = () => ctxMenu.style.display = 'none';

function triggerDelete() { ws.send(JSON.stringify({ type: 'delete', id: selectedMsgId })); }
function triggerEdit() {
  const msg = messagesMap[selectedMsgId];
  const newText = prompt("Edit message:", msg.text);
  if(newText && newText !== msg.text) ws.send(JSON.stringify({ type: 'edit', id: selectedMsgId, text: newText }));
}
function triggerReply() {
  currentReplyId = selectedMsgId;
  const msg = messagesMap[selectedMsgId];
  document.getElementById('replyTextDisplay').innerText = msg.text || (msg.mediaType ? 'üì∑ Media' : '...');
  replyContainer.style.display = 'block';
  textInput.focus();
}
function cancelReply() { currentReplyId = null; replyContainer.style.display = 'none'; }
function removeMessageUI(id) {
  const el = document.querySelector(`.msg-row[data-id="${id}"] .msg-content`);
  if(el) { el.innerHTML = `<i style="color:#8696a0;font-size:13px;">üö´ Deleted</i>`; el.parentNode.querySelector('img')?.remove(); }
}
function updateMessageUI(id, newText) {
  const el = document.querySelector(`.msg-row[data-id="${id}"] .msg-content`);
  if(el) el.innerText = newText;
}

document.getElementById('fileInput').addEventListener('change', async function() {
  const file = this.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append('file', file);
  const res = await fetch('/upload', { method: 'POST', body: formData });
  const data = await res.json();
  if (data.url) sendMessage(data.url, file.type.startsWith('image') ? 'image' : 'file');
});

const picker = document.getElementById('emojiPicker');
["üòÄ","üòÇ","üòç","ü•∫","üòé","üò≠","üò°","üëç","üëé","üéâ","üî•","‚ù§Ô∏è","üíî"].forEach(e => {
  const s = document.createElement('span'); s.className = 'emoji-item'; s.innerText = e;
  s.onclick = () => { textInput.value += e; toggleSendButton(); };
  picker.appendChild(s);
});
function toggleEmoji() { picker.style.display = picker.style.display === 'grid' ? 'none' : 'grid'; }
</script>
</body>
</html>